<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista Formulario de Sesión -->
    <record id="view_academia_sesion_form" model="ir.ui.view">
        <field name="name">academia.sesion.form</field>
        <field name="model">academia.sesion</field>
        <field name="arch" type="xml">
            <form string="Sesión">
                <header>
                    <button name="action_confirm" string="Confirmar" type="object"
                        invisible="state != 'draft'" class="btn-primary"/>
                    <button name="action_done" string="Marcar Realizada" type="object"
                        invisible="state != 'confirmed'" class="btn-primary"/>
                    <button name="action_cancel" string="Cancelar" type="object"
                        invisible="state in ['done', 'cancelled']"/>
                    <button name="action_draft" string="Volver a Borrador" type="object"
                        invisible="state != 'cancelled'"/>
                    <field name="state" widget="statusbar" 
                        statusbar_visible="draft,confirmed,done"/>
                </header>
                <sheet>
                    <group>
                        <group string="Información General">
                            <field name="curso_id"/>
                            <field name="clase_id"/>
                            <field name="profesor_id"/>
                            <field name="topic"/>
                        </group>
                        <group string="Horario">
                            <field name="date"/>
                            <field name="start_time" widget="float_time"/>
                            <field name="duration"/>
                            <field name="end_time" widget="float_time"/>
                            <field name="room"/>
                        </group>
                    </group>
                    <group>
                        <group string="Capacidad">
                            <field name="seats"/>
                            <field name="total_asistentes"/>
                            <field name="seats_available"/>
                            <field name="is_full" invisible="1"/>
                            <div class="text-danger fw-bold" invisible="not is_full">
                                ⚠️ SESIÓN COMPLETA
                            </div>
                        </group>
                        <group string="Ocupación">
                            <field name="occupancy_rate" widget="progressbar"/>
                            <field name="color" invisible="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Asistentes" name="asistentes">
                            <field name="alumno_ids">
                                <list>
                                    <field name="display_name"/>
                                    <field name="email"/>
                                    <field name="phone"/>
                                </list>
                            </field>
                        </page>
                        <page string="Notas" name="notas">
                            <field name="notes" placeholder="Notas de la sesión..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Vista Lista de Sesión -->
    <record id="view_academia_sesion_list" model="ir.ui.view">
        <field name="name">academia.sesion.list</field>
        <field name="model">academia.sesion</field>
        <field name="arch" type="xml">
            <list string="Sesiones" 
                decoration-danger="is_full == True"
                decoration-warning="occupancy_rate &gt;= 80 and is_full == False"
                decoration-info="state == 'confirmed' and occupancy_rate &lt; 80"
                decoration-success="state == 'done'"
                decoration-muted="state == 'cancelled'">
                <field name="date"/>
                <field name="curso_id"/>
                <field name="clase_id" optional="show"/>
                <field name="profesor_id"/>
                <field name="start_time" widget="float_time"/>
                <field name="duration"/>
                <field name="total_asistentes"/>
                <field name="seats"/>
                <field name="occupancy_rate" widget="progressbar"/>
                <field name="is_full" column_invisible="1"/>
                <field name="state" widget="badge"
                    decoration-info="state == 'draft'"
                    decoration-primary="state == 'confirmed'"
                    decoration-success="state == 'done'"
                    decoration-danger="state == 'cancelled'"/>
            </list>
        </field>
    </record>

    <!-- Vista Calendario de Sesión (Mejorada) -->
    <record id="view_academia_sesion_calendar" model="ir.ui.view">
        <field name="name">academia.sesion.calendar</field>
        <field name="model">academia.sesion</field>
        <field name="arch" type="xml">
            <calendar string="Calendario de Sesiones" 
                date_start="date" 
                color="color" 
                mode="month" 
                quick_create="0"
                event_open_popup="true"
                hide_time="true">
                <field name="name"/>
                <field name="profesor_id" avatar_field="avatar_128"/>
                <field name="curso_id"/>
                <field name="clase_id"/>
                <field name="room"/>
                <field name="start_time" widget="float_time"/>
                <field name="end_time" widget="float_time"/>
                <field name="total_asistentes"/>
                <field name="seats"/>
                <field name="occupancy_rate" widget="progressbar"/>
                <field name="state"/>
            </calendar>
        </field>
    </record>

    <!-- Vista Kanban de Sesión -->
    <record id="view_academia_sesion_kanban" model="ir.ui.view">
        <field name="name">academia.sesion.kanban</field>
        <field name="model">academia.sesion</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column" sample="1">
                <field name="id"/>
                <field name="name"/>
                <field name="curso_id"/>
                <field name="clase_id"/>
                <field name="profesor_id"/>
                <field name="date"/>
                <field name="start_time"/>
                <field name="end_time"/>
                <field name="room"/>
                <field name="total_asistentes"/>
                <field name="seats"/>
                <field name="occupancy_rate"/>
                <field name="is_full"/>
                <field name="state"/>
                <field name="color"/>
                <progressbar field="state" colors='{"draft": "muted", "confirmed": "info", "done": "success", "cancelled": "danger"}'/>
                <templates>
                    <t t-name="kanban-card">
                        <div t-attf-class="#{record.is_full.raw_value ? 'bg-danger-subtle' : ''} oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top mb-1">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="curso_id"/>
                                        </strong>
                                    </div>
                                    <div class="o_kanban_record_top_image">
                                        <field name="profesor_id" widget="many2one_avatar_user"/>
                                    </div>
                                </div>
                                <div class="text-muted mb-1">
                                    <i class="fa fa-calendar me-1"/> <field name="date"/>
                                </div>
                                <div class="text-muted mb-1">
                                    <i class="fa fa-clock-o me-1"/> 
                                    <field name="start_time" widget="float_time"/> - 
                                    <field name="end_time" widget="float_time"/>
                                </div>
                                <div t-if="record.clase_id.value" class="text-muted mb-1">
                                    <i class="fa fa-users me-1"/> <field name="clase_id"/>
                                </div>
                                <div t-if="record.room.value" class="text-muted mb-1">
                                    <i class="fa fa-map-marker me-1"/> <field name="room"/>
                                </div>
                                <div class="o_kanban_record_bottom mt-2">
                                    <div class="oe_kanban_bottom_left">
                                        <span class="badge" t-attf-class="#{record.is_full.raw_value ? 'text-bg-danger' : 'text-bg-secondary'}">
                                            <i class="fa fa-user me-1"/>
                                            <field name="total_asistentes"/>/<field name="seats"/>
                                        </span>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="occupancy_rate" widget="progressbar" 
                                            options="{'current_value': 'occupancy_rate', 'max_value': 100, 'editable': false}"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vista Búsqueda de Sesión (Mejorada) -->
    <record id="view_academia_sesion_search" model="ir.ui.view">
        <field name="name">academia.sesion.search</field>
        <field name="model">academia.sesion</field>
        <field name="arch" type="xml">
            <search string="Buscar Sesiones">
                <field name="name"/>
                <field name="curso_id"/>
                <field name="clase_id"/>
                <field name="profesor_id"/>
                <field name="date"/>
                <field name="room"/>
                <field name="topic"/>
                <separator/>
                <filter string="Mis Sesiones" name="my_sessions" 
                    domain="[('profesor_id.user_id', '=', uid)]"/>
                <filter string="Hoy" name="today" 
                    domain="[('date', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Esta Semana" name="this_week" 
                    domain="[('date', '>=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')), ('date', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter string="Próximas" name="upcoming" 
                    domain="[('date', '>=', context_today().strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter string="Borrador" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Confirmadas" name="confirmed" domain="[('state', '=', 'confirmed')]"/>
                <filter string="Realizadas" name="done" domain="[('state', '=', 'done')]"/>
                <filter string="Canceladas" name="cancelled" domain="[('state', '=', 'cancelled')]"/>
                <separator/>
                <filter string="Con Plazas" name="available" domain="[('is_full', '=', False)]"/>
                <filter string="Completas" name="full" domain="[('is_full', '=', True)]"/>
                <separator/>
                <group expand="0" string="Agrupar por">
                    <filter string="Estado" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="Curso" name="group_curso" context="{'group_by': 'curso_id'}"/>
                    <filter string="Clase" name="group_clase" context="{'group_by': 'clase_id'}"/>
                    <filter string="Profesor" name="group_profesor" context="{'group_by': 'profesor_id'}"/>
                    <filter string="Fecha" name="group_date" context="{'group_by': 'date:week'}"/>
                    <filter string="Nivel" name="group_nivel" context="{'group_by': 'nivel'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Acción de Sesión -->
    <record id="action_academia_sesion" model="ir.actions.act_window">
        <field name="name">Sesiones</field>
        <field name="res_model">academia.sesion</field>
        <field name="view_mode">kanban,list,calendar,form</field>
        <field name="search_view_id" ref="view_academia_sesion_search"/>
        <field name="context">{'search_default_upcoming': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡Programa tu primera sesión!
            </p>
            <p>
                Las sesiones representan clases individuales con fecha, hora y asistentes.
                Usa la vista Kanban para organizar por estado o la vista Calendario para ver la planificación.
            </p>
        </field>
    </record>

    <!-- Acción Calendario de Sesiones -->
    <record id="action_academia_sesion_calendar" model="ir.actions.act_window">
        <field name="name">Calendario de Sesiones</field>
        <field name="res_model">academia.sesion</field>
        <field name="view_mode">calendar,kanban,list,form</field>
        <field name="search_view_id" ref="view_academia_sesion_search"/>
        <field name="context">{'search_default_upcoming': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡El calendario está vacío!
            </p>
            <p>
                Programa sesiones para verlas en el calendario.
            </p>
        </field>
    </record>

    <!-- Menú de Sesión -->
    <menuitem 
        id="menu_academia_sesion"
        name="Sesiones"
        parent="menu_academia_management"
        action="action_academia_sesion"
        sequence="30"/>

    <!-- Menú Calendario (en sección Planificación) -->
    <menuitem 
        id="menu_academia_calendar"
        name="Calendario"
        parent="menu_academia_planning"
        action="action_academia_sesion_calendar"
        sequence="10"/>

    <!-- Menú Planificación Sesiones (en sección Planificación) -->
    <menuitem 
        id="menu_academia_sesion_planning"
        name="Tablero Sesiones"
        parent="menu_academia_planning"
        action="action_academia_sesion"
        sequence="20"/>
</odoo>
